<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>用户信息</title>
    <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/css/bootstrap.min.css">  
    <script src="https://cdn.staticfile.org/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://cdn.bootcss.com/jquery-cookie/1.4.1/jquery.cookie.js"></script>
    <script src="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
</head>
<body>

    <!-- 模态框（Modal） -->
    <div class="modal fade" id="userMessage" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                        &times;
                    </button>
                    <h4 class="modal-title" id="myModalLabel">
                        用户中心
                    </h4>
                </div>
                <div class="modal-body" style="height: 300px;">
                    <div style="width: 20%; float: left;" id="nav">
                        <ul class="nav nav-pills nav-stacked">
                            <li class="active"><a href="#" onclick="showA()"><span class="glyphicon glyphicon-user"></span> 用户</a></li>
                            <li><a href="#" onclick="showB()">修改密码</a></li>
                            <li><a href="#" onclick="showC()">功能1</a></li>
                            <li><a href="#" onclick="showD()">功能2</a></li>
                            <li><a href="#" onclick="showE()">功能3</a></li>
                        </ul>
                    </div>
                    <div style="width: 420px; height: 260px; float: left; margin-left: 20px; text-align: center;">
                        <div id="a" style="margin-top: 80px;">
                            <h2>(这里展示用户名)</h2>
                            <h3 id="user"></h3>
                            <button class="btn btn-message" id="logout">注销</button>
                        </div>
                        <div id="b">
                            <div style="margin-top: 80px;">
                                原密码:<input type="text" id="oldPassword"><br>
                                新密码:<input type="text" id="newPassword"><br>
                                <button class="btn btn-danger" id="update">确认修改</button>
                            </div>
                        </div>
                        <div id="c">
                            <h2>功能1</h2>
                        </div>
                        <div id="d">
                            <h2>功能2</h2>
                        </div>
                        <div id="e">
                            <h2>功能3</h2>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-dismiss="modal" id="close">
                        关闭
                    </button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal -->
    </div>

    <script>
        //浏览器直接加载
        $(function(){
            //从cookie中读取用户名
            $('#user').text(
                $.cookie('userName')
            );

            $('#userMessage').modal('show');
            hideAll();
            $('#a').show();
        })

         //初始化模态框
        $("#userMessage").modal({
            //点击背景不关闭
            backdrop:"static",
            //触发键盘esc事件时不关闭
            keyboard: false
        });

        //判断原密码是否正确
        $('#oldPassword').blur(function(){
            var userName = $.cookie('userName');
            var oldPassword = $('#oldPassword').val();
            if (oldPassword != '') {
                selectPasswordByUserName(userName);
            }
        })

        //判断新密码格式
        $('#newPassword').blur(function(){
            var passwordSize = /^[A-Za-z0-9]{6,13}$/;
            if ($('#newPassword').val() != '') {
                if (!passwordSize.test($('#newPassword').val())) {
                    alert('密码格式有误');
                }
                if ($('#newPassword').val() == $('#oldPassword').val()) {
                    alert('新密码与旧密码不可以相同')
                }
            }
        })

        //确认修改密码按钮事件
        $('#update').click(function(){
            $.ajax({
                type: 'POST',
                url: 'http://localhost:8080/updatePassword',
                data: {
                    'userName':userName,
                    'password':$('#newPassword').val()
                },
                success: function(result){
                    if (result > 0) {
                        alert('修改成功,请重新登陆');
                        $.cookie('userName', null);
                        $(location).prop('href', 'login.html');
                    }
                },
                error: function (e) {
                    alert('服务器错误');
                }
            })
        })

        //关闭模态框事件
        $('#close,.close').click(function(){
            setTimeout(function(){
                window.opener = null;
                window.open('', '_self');
                window.close();
            },100)
        })

        //隐藏全部
        function hideAll(){
            $('#a').hide();
            $('#b').hide();
            $('#c').hide();
            $('#d').hide();
            $('#e').hide();
        }

        //展示第一个功能
        function showA(){
            hideAll();
            $('#a').show();
        }
        //2
        function showB(){
            hideAll();
            $('#b').show();
        }
        //3
        function showC(){
            hideAll();
            $('#c').show();
        }
        //4
        function showD(){
            hideAll();
            $('#d').show();
        }
        //5
        function showE(){
            hideAll();
            $('#e').show();
        }

        //active动态绑定
        var li = $('#nav li');
        for (var i = 0; i < li.length; i++){
            li[i].onclick = function () {
                for (var i = 0; i < li.length; i++) {
                    li[i].className = '';
                    this.className='active';
                }
            }
        }

        //注销按钮事件
        $('#logout').click(function(){
            if (confirm("确认注销用户吗?")) {
                //删除cookie
                $.cookie('userName', null); 
                $('#user').text('');
                //跳转回登录页面
                $(location).prop('href', 'login.html');
            }
        })

        //根据用户名查询用户密码
        function selectPasswordByUserName(userName){
            $.ajax({
                type: 'GET',
                url: 'http://localhost:8080/selectPassword',
                data: {'userName':userName},
                success: function(password){
                    if (password != $('#oldPassword').val()) {
                        alert('密码错误');
                    }
                },
                error: function (e) {
                    alert('服务器错误');
                }
            })
        }

    </script>

    
</body>
</html>