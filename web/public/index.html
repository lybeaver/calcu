<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>菜单查询</title>
    <link href="https://cdn.bootcss.com/twitter-bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.bootcss.com/bootstrap-table/1.12.2/bootstrap-table.css" rel="stylesheet">
    <link href="https://cdn.bootcss.com/bootstrap-table/1.12.2/extensions/reorder-rows/bootstrap-table-reorder-rows.css" rel="stylesheet">
    <script src="https://cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
    <script src="https://cdn.bootcss.com/jquery.qrcode/1.0/jquery.qrcode.min.js"></script>
    <script src="https://cdn.bootcss.com/jquery-cookie/1.4.1/jquery.cookie.js"></script>
    <script src="https://cdn.bootcss.com/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://cdn.bootcss.com/bootbox.js/4.4.0/bootbox.js"></script>
    <script src="https://cdn.bootcss.com/bootstrap-table/1.12.2/bootstrap-table.js"></script>
    <script src="https://cdn.bootcss.com/bootstrap-table/1.12.2/locale/bootstrap-table-zh-CN.js"></script>
    <script src="https://cdn.bootcss.com/TableDnD/1.0.3/jquery.tablednd.min.js"></script>
    <script src="https://cdn.bootcss.com/bootstrap-table/1.12.2/extensions/reorder-rows/bootstrap-table-reorder-rows.js"></script>
    <style>
    th,td{
        text-align: center;
        width: 10%;
    }
    #add{
        float: left;
        margin-left: 33.5%;
        margin-top: 5px;
    }
    </style>
</head>
<body>
    
    <!-- 添加导航栏 -->
    <div class="navbar navbar-inverse" style="text-align: center;">
        <div class="container-fluid" style="text-align: center;">
            <div class="navbar-header" style="margin-left: 20px;">
                <a class="navbar-brand" href="#" onclick="showAll()">所有菜品</a>
            </div>
            <div class="collapse navbar-collapse">
                <ul class="nav navbar-nav" style="margin-left: 30px;">
                   <li><a href="#">主食</a></li>
                   <li><a href="#">荤菜</a></li>
                   <li><a href="#">素菜</a></li>
                   <li><a href="#">海鲜</a></li>
                   <li><a href="#">面食</a></li>
                   <li><a href="#">小吃</a></li>
                   <li><a href="#">汤品</a></li>
                   <li><a href="#">饮品</a></li>
                   <li><a href="#">水果</a></li>
                </ul>
            </div>
        </div>
    </div>

    <input type="hidden" id="userType" value="">
    <h1 style="text-align: center; margin-top: 50px;" id="title">菜品一览</h1>

    <!-- 添加用户栏 -->
    <div style="float: right; margin-right: 15%;" id="welcome" class="dropdown">
        <span class="glyphicon glyphicon-question-sign tooltip-show" data-toggle="tooltip" title="看什么看，有啥问题都给我忍着!"></span>
        欢迎<a href="#" id="user" class="dropdown-toggle" data-toggle="dropdown"></a>
        <ul class="dropdown-menu" role="menu" aria-labelledby="dLabel">
            <li role="presentation">
                <a role="menuitem" tabindex="-1" href="#" onclick="jump()">个人中心</a>
            </li>
            <li role="presentation">
                <a role="menuitem" tabindex="-1" href="#" onclick="money()">钱包</a>
            </li>
            <li role="presentation" class="dropdown-submenu">
                <a role="menuitem" tabindex="-1" href="#">订单中心<span class="badge pull-right">0</span></a>
                <ul class="dropdown-menu">
                    <li>111</li>
                    <li>222</li>
                    <li>333</li>
                </ul>
            </li>
            <li role="presentation" class="divider"></li>
            <li role="presentation">
                <a role="menuitem" tabindex="-1" href="#" onclick="backUp()">注销</a>
            </li>
        </ul>
    </div>

    <div class="input-group col-md-3 col-md-push-4" id="select" style="float: left; padding: 5px;">
        <input type="text" class="form-control" id="name" placeholder="请输入菜名">
        <span class="input-group-addon btn btn-primary" onclick="selectLikeName()" style="cursor: pointer;">搜索</span>
    </div>
    <button class="btn btn-success" data-toggle="modal" data-target="#myModal" id="add">
        添加
    </button>
    
    <!-- 模态框（Modal） -->
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form class="form-horizontal" autocomplete="off">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                            &times;
                        </button>
                        <h4 class="modal-title" id="myModalLabel">
                            请输入菜品信息
                        </h4>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="foodId">
                        <div class="form-group">
                            <label for="" class="col-sm-2 control-label">菜名:</label>
                            <div class="col-sm-6">
                                <input type="text" class="form-control" id="foodName">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="" class="col-sm-2 control-label">类型:</label>	
                            <div class="col-sm-6">
                                <select class="selectpicker show-tick form-control" id="foodType" data-live-search="false">
                                    <option value="0">--请选择--</option>
                                    <option>主食</option>
                                    <option>荤菜</option>
                                    <option>素菜</option>
                                    <option>海鲜</option>
                                    <option>面食</option>
                                    <option>小吃</option>
                                    <option>汤品</option>
                                    <option>饮品</option>
                                    <option>水果</option>
                                </select>
                            </div>
                            <div class="col-sm-4 tips"></div>
                        </div>
                        <div class="form-group">
                            <label for="" class="col-sm-2 control-label">价格:</label>
                            <div class="col-sm-6">
                                <input type="text" class="form-control" id="foodPrice">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="" class="col-sm-2 control-label">剩余数量:</label>
                            <div class="col-sm-6">
                                <input type="text" class="form-control" id="foodNum">
                            </div>
                            <div class="col-sm-4 tips"></div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">
                            关闭
                        </button>
                        <button type="button" class="btn btn-primary" onclick="insertORupdate()" data-dismiss="modal" id="insORupd">
                            提交
                        </button>
                    </div>
                </form>
            </div><!-- /.modal-content -->
        </div><!-- /.modal -->
    </div>
    
    <!-- 菜品信息显示表 -->
    <div class="col-md-9" style="margin-left: 12.5%;" id="a">
        菜单
        <table  class="table table-condensed" id="table" data-unique-id="foodId"></table>
    </div>

    <!-- 订单信息显示表 -->
    <div class="col-md-6" style="margin-left: 25%;" id="b">
        订单表
        <table class="table table-condensed" id="order" data-unique-id="foodId"></table>
        共计:<span id="allPrice">0</span>元
        <button id="get" style="float: right; margin-top: 5px;" class="btn btn-success">结算</button>
    </div>

    <script>

        //鼠标移入疑问按钮事件
        $('.tooltip-show').mouseover(function(){
            $('.tooltip-show').tooltip('show');
        })

        //导航栏点击事件
        $('.nav li').click(function(){
            var foodType = $(this).children().html();
            selectFoodsByFoodType(foodType);
        })

        //根据菜品类型查询菜品信息
        function selectFoodsByFoodType(foodType){
            $.ajax({
                type: 'GET',
                url: 'http://localhost:8080/foodType',
                data: {
                        'foodType':foodType
                },
                success: function(foods){
                    $('#table').bootstrapTable('removeAll');
                    $('#table').bootstrapTable('append', foods);     //将获取的数据添加到表格
                },
                error: function(e){
                    alert('系统异常');
                }
            })
        }

        //所有菜品点击事件
        function showAll(){
            selectAll();
        }

        //创建订单第一步(添加基本订单信息)
        $('#get').click(function(){
            if (JSON.stringify($('#order').bootstrapTable('getData')) == '[]') {
                alert('您还没有点餐，不能提交订单哦!');
            }
            else{
                if (confirm("确认提交订单吗?")) {
                    $.ajax({
                        type: 'POST',
                        url: 'http://localhost:8080/insertOrders',
                        data: {
                            'userName':$('#user').html(),
                            'orderPrice':$('#allPrice').html()
                        },
                        success: function(id){
                            setTimeout(function(){
                                //alert('订单创建成功');
                                //创建订单第二步(添加详细订单信息)
                                var orderId = id;
                                for(var i = 0; i < $('#order').find('tr').length-1; i++){
                                    $('#order').bootstrapTable('updateCell',{
                                        index : i, //更新列所在行的索引
                                        field : 'orderId', //要更新列的field
                                        value : orderId //要更新列的数据
                                    })
                                };
                                $.ajax({
                                    type: 'POST',
                                    url: 'http://localhost:8080/insertItems',
                                    data: JSON.stringify($('#order').bootstrapTable('getData')),
                                    contentType: 'application/json',
                                    success: function(result){
                                        if (result == 1) {
                                            setTimeout(function(){
                                                alert('订单信息输入成功');
                                                $('#order').bootstrapTable('removeAll');
                                                $('#allPrice').html(0);
                                                $(location).prop('href', 'order.html');
                                            },100);                                            
                                        }else{
                                            alert('失败啦!')
                                        }
                                    },
                                    error: function(e){
                                        alert('系统错误');
                                        //根据订单id删除订单
                                        $.ajax({
                                            type: 'POST',
                                            url: 'http://localhost:8080/deleteNullOrder',
                                            data: {
                                                'orderId': orderId
                                            },
                                            success: function(result){
                                                if (result > 0) {
                                                    alert('无效订单已删除');
                                                }
                                            },
                                            error: function(e){
                                                alert('系统错误');
                                            }
                                        })
                                    }
                                })
                            },200);
                        },
                        error: function(e){
                            alert('系统错误');
                        }
                    })
                }
            }
        })

        //菜品信息全查询
        function selectAll(){
            $.ajax({
                url: 'http://localhost:8080/selectAll',  //路径
                type: 'GET',                        //请求类型
                async: true,                        //false同步,true异步
                success: function (foods) {
                    $('#table').bootstrapTable('removeAll');
                    $('#table').bootstrapTable('append', foods);     //将获取的数据添加到表格
                },
                error:function(e){
                    alert(e.readyState);            //显示错误码(1-正在载入，2-已经载入，3-数据进行交互，4-完成)
                }
            })
        }

        //添加菜品信息
        function insertFood(){
            $.ajax({
                type: 'POST',
                url: 'http://localhost:8080/insertFood',
                data: {
                    'foodName':$('#foodName').val(),
                    'foodType':$('#foodType option:selected').val(),
                    'foodPrice':$('#foodPrice').val(),
                    'foodNum':$('#foodNum').val()
                },
                success: function(result){
                    if(result == 1){
                        setTimeout(function(){
                            alert('添加成功');
                        },200);
                    }else{
                        alert('添加失败');
                    }
                },
                error: function(e){
                    alert('系统错误')
                }
            })
        }

        //修改菜品信息
        function updateFood(){
            $.ajax({
                type: 'POST',
                url: 'http://localhost:8080/updateFood',
                data: {
                    'foodId':$('#foodId').val(),
                    'foodName':$('#foodName').val(),
                    'foodType':$('#foodType option:selected').val(),
                    'foodPrice':$('#foodPrice').val(),
                    'foodNum':$('#foodNum').val()
                },
                success: function(result){
                    if(result == 1){
                        setTimeout(function(){
                            alert('修改成功');
                        },200);
                    }else{
                        alert('修改失败');
                    }
                },
                error: function(e){
                    alert('系统错误')
                }
            })
        }

        //删除菜品信息
        function deleteFood(foodId){
            $.ajax({
                type: 'POST',
                url: 'http://localhost:8080/deleteFood',
                data: {'foodId':foodId},
                success: function (result) {
                    if(result == 1){
                        setTimeout(function(){
                            alert('删除成功');
                        },200);
                    }else{
                        alert('删除失败');
                    }
                },
                error: function(e){
                    alert('系统错误')
                }
            });
        }

        //菜品信息模糊查询
        function selectLikeName(){
            $.ajax({
                type: 'GET',
                url: 'http://localhost:8080/menu',
                data: {
                        'foodName':$('#name').val()
                },
                success: function(foods){
                    $('#table').bootstrapTable('removeAll');
                    $('#table').bootstrapTable('append', foods);     //将获取的数据添加到表格
                },
                error: function(e){
                    alert(e.readyState);
                }
            })
        }

        //浏览器直接加载
        $(function(){

            $('#model').hide();

            //判断用户是否存在于cookie
            if ($.cookie('userName') != null && $.cookie('userName') != 'null') {
                //从cookie中读取用户名
                $('#user').text($.cookie('userName'));

                //查询用户权限
                selectUserTypeByUserName();

                //表格初始化
                $('#table').bootstrapTable({
                    height: "347",
                    pageSizeSelect: true,
                    pagingLittleToolbar: true,
                    pageIncorrectTurnAlert: false,
                    striped: true,
                    toolbar: '#toolbar',
                    useRowAttrFunc: true,
                    useCurrentPage: true,
                    striped: true, // 是否显示行间隔色
                    pageSize: "5",
                    pageList: [5, 10, 15],        //可供选择的每页的行数（*）
                    pagination: true, // 是否分页
                    paginationLoop: false,             //是否无限循环
                    columns: [
                        { 
                            field: 'buy', 
                            title: '加入购物车', 
                            width: '10%',
                            events: addCarEvents,
                            formatter: addCarFormatter
                        },
                        { field: 'foodId', title: 'ID',width: '6%' },
                        { field: 'foodName', title: '菜名' },
                        { field: 'foodType', title: '类型' },
                        { field: 'foodPrice', title: '价格' },
                        { field: 'foodNum', title: '剩余数量' },
                        {
                            field: 'foodTools',
                            title: '操作',
                            width: '19%',
                            events: operateEvents,
                            formatter: operateFormatter
                        }
                    ],
                });
                selectAll();
                
                //订单表初始化
                $('#order').bootstrapTable({
                    height: "200",
                    striped: true,
                    toolbar: '#toolbar',
                    useRowAttrFunc: true,
                    useCurrentPage: true,
                    striped: true, // 是否显示行间隔色
                    columns: [
                        { field: 'orderId', title: '订单号', visible: false },
                        { field: 'foodId', title: 'ID' },
                        { field: 'foodName', title: '菜名' },
                        { field: 'foodPrice', title: '单格' },
                        { field: 'num', title: '数量' },
                        { field: 'price', title: '总价' },
                        {
                            field: 'tools',
                            title: '操作',
                            events: delEvents,
                            formatter: delFormatter
                        }
                    ]
                })
            
                //隐藏添加按钮
                setTimeout(function(){
                    if ($('#userType').val() != 0) {
                        $('#add').hide();
                    }
                },100)

                //查询用户未完成订单数量
                $.ajax({
                    type: 'GET',
                    url: 'http://localhost:8080/selectOrderTypeNum',
                    data: {
                            'userName':$.cookie('userName')
                    },
                    success: function(result){
                        $('.badge').html(result);
                    },
                    error: function(e){
                        alert('系统错误');
                    }
                })

            }else{
                alert('用户你好，请登录!');
                $(location).prop('href', 'login.html');
            }

        })

        //加入购物车按钮
        function addCarFormatter(value, row, index){
            return [
                '<a href="#" class="btn btn-warning" id="buy"><span class="glyphicon glyphicon-shopping-cart"></span></a>'
            ].join('');
        }

        //订单表取消按钮
        function delFormatter(value, row, index){
            return [
                '<button class="btn btn-danger" id="esc">移除</button>'
            ].join('');
        }

        //向表格添加操作按钮
        function operateFormatter(value, row, index) {
                if ($('#userType').val() != 0) {
                    return;
                }else{
                    return [
                        '<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#myModal" id="rowUpd">修改</button>',
                        '<button type="button" class="btn btn-danger" id="rowDel" style="margin-left: 10px;">删除</button>'
                    ].join('');
                }
        };

        //操作按钮触发事件
        window.operateEvents = {
            'click #rowDel': function (e, value, row, index) {
                if (confirm("确认删除吗?")) {
                    var foodId=$(this).parent().parent().attr("data-uniqueid");
                    deleteFood(foodId);
                    setTimeout('selectAll()',300);
                }                
            },
            'click #rowUpd': function(e, value, row, index){
                var foodId = row.foodId;
                var foodName = row.foodName;
                var foodType = row.foodType;
                var foodPrice = row.foodPrice;
                var foodNum = row.foodNum;
                $('#foodId').val(foodId);
                $('#foodName').val(foodName);
                $('#foodType').val(foodType);
                $('#foodPrice').val(foodPrice);
                $('#foodNum').val(foodNum);
                $('#insORupd').text("修改");
            }
        };

        //加入购物车按钮事件
        var num = 1;
        var allPrice = 0;
        window.addCarEvents = {
            'click #buy': function(e, value, row, index){
                var foodId = row.foodId;
                var foodName = row.foodName;
                var foodPrice = row.foodPrice;
                var foodNum = row.foodNum;
                //菜单表数量减少
                $('#table').bootstrapTable('updateCell',{
                    index : index,
                    field : 'foodNum',
                    value : foodNum-1
                })
                if ($('#order').bootstrapTable('getRowByUniqueId',foodId) == null) {
                    num = 1;
                    $('#order').bootstrapTable('prepend',{
                        'foodId':foodId,
                        'foodName':foodName,
                        'foodPrice':foodPrice,
                        'num':num,
                        'price': foodPrice
                    }),
                    num == 0;
                }else{
                    num += 1;
                    $('#order').bootstrapTable('remove',{
                        field: 'foodId',
                        values: [foodId]
                    })
                    $('#order').bootstrapTable('prepend',{
                        'foodId':foodId,
                        'foodName':foodName,
                        'foodPrice':foodPrice,
                        'num':num,
                        'price': foodPrice*num
                    })
                };
                allPrice += foodPrice;
                $('#allPrice').html(allPrice);
            }
        }

        //取消按钮事件
        window.delEvents = {
            'click #esc': function(e, value, row, index){
                var foodId = row.foodId;
                $('#order').bootstrapTable('remove',{
                    field: 'foodId',
                    values: [foodId]
                });
                var price = row.price;
                allPrice = allPrice-price;
                $('#allPrice').html(allPrice);
            }
        }

        //添加前的操作
        $('#add').click(function(){
            $('#foodId').val('');
            $('#foodName').val('');
            $('#foodType').val('');
            $('#foodPrice').val('');
            $('#foodNum').val('');
            $('#insORupd').text("添加");
        })

        //对表格信息进行添加或修改
        function insertORupdate(){
            if ($('#insORupd').text() == '添加') {
                insertFood();
            }
            if ($('#insORupd').text() == '修改') {
                updateFood();
            };
            setTimeout('selectAll()',300);
        }
        
        //隐藏所有信息
        function hideAll(){
            $('#title').hide();
            $('#welcome').hide();
            $('#select').hide();
            $('#add').hide();
            $('#a').hide();
            $('#b').hide();
        }
    
        //查询用户状态
        function selectUserTypeByUserName(){
            $.ajax({
                type: 'GET',
                url: 'http://localhost:8080/selectUserType',
                data: {
                        'userName':$.cookie('userName')
                },
                success: function(userType){
                    $('#userType').val(userType);
                },
                error: function(e){
                    alert('系统错误');
                }
            })
        }

        //显示用户信息
        function jump(){
            window.open("user.html");
        }

        //钱包按钮点击事件
        function money(){
            alert('钱包空空如也，就像你的脸一样，干干净净!');
        }

        //注销按钮事件
        function backUp(){
            if (confirm("确认注销用户吗?")) {
                //删除cookie
                $.cookie('userName', null); 
                $('#user').text('');
                //跳转回登录页面
                $(location).prop('href', 'login.html');
            }
        }

        
    </script>
    
</body>
</html>